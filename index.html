<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA / Add to Home Screen Meta Tags for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Budget">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <title>Budget App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            background-color: #f3f4f6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.25rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            padding: 1.5rem;
        }
        .input-field {
            background-color: #f9fafb;
            border-color: #e5e7eb;
        }
        .input-field:focus {
             --tw-ring-color: rgb(59 130 246 / 0.5);
             border-color: #3b82f6;
        }
        .nav-tab.active {
            color: #2563eb;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-700">

    <div class="container mx-auto max-w-lg p-4 pb-24">
        <header class="text-center my-6 relative">
            <h1 class="text-4xl font-bold text-gray-800">Budget Tracker</h1>
        </header>

        <div id="app-content">
            <main id="budget-page" class="space-y-8">
                <section id="summary" class="card">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-2 border-b border-gray-200 pb-2">Summary</h2>
                    <div class="grid grid-cols-3 gap-4 text-center py-4">
                        <div>
                            <p class="text-gray-500 text-sm">Total Income</p>
                            <p id="total-income" class="text-2xl font-bold text-green-600">$0.00</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Saved</p>
                            <p id="total-saved" class="text-2xl font-bold text-blue-600">$0.00</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Invested</p>
                            <p id="total-invested" class="text-2xl font-bold text-purple-600">$0.00</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Period:</label>
                        <div class="flex space-x-2">
                            <select id="month-select" class="block w-full rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-gray-800 border-gray-200 bg-gray-50"></select>
                            <select id="year-select" class="block w-full rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 text-gray-800 border-gray-200 bg-gray-50"></select>
                        </div>
                    </div>
                </section>

                <section id="income-section" class="card">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Monthly Income</h2>
                        <select id="pay-frequency" class="text-sm rounded-lg border-gray-200 bg-gray-50 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-1">
                            <option value="bi-weekly">Bi-weekly</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="paycheck1" class="block text-sm font-medium text-gray-600">Paycheck 1</label>
                            <input type="number" id="paycheck1" placeholder="0.00" step="0.01" class="paycheck-input input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="paycheck2" class="block text-sm font-medium text-gray-600">Paycheck 2</label>
                            <input type="number" id="paycheck2" placeholder="0.00" step="0.01" class="paycheck-input input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2">
                        </div>
                        <div id="weekly-paychecks" class="space-y-4 hidden">
                            <div>
                                <label for="paycheck3" class="block text-sm font-medium text-gray-600">Paycheck 3</label>
                                <input type="number" id="paycheck3" placeholder="0.00" step="0.01" class="paycheck-input input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="paycheck4" class="block text-sm font-medium text-gray-600">Paycheck 4</label>
                                <input type="number" id="paycheck4" placeholder="0.00" step="0.01" class="paycheck-input input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2">
                            </div>
                        </div>
                    </div>
                </section>
                
                <section id="paycheck-breakdown-section" class="card">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Paycheck Breakdown</h2>
                        <select id="breakdown-paycheck-select" class="text-sm rounded-lg border-gray-200 bg-gray-50 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-1"></select>
                    </div>
                    <div id="breakdown-details" class="space-y-2"></div>
                </section>

                <section id="add-transaction" class="card">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Add Bill/Expense</h2>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Total: <span id="total-monthly-bills-display" class="font-semibold text-red-600">$0.00</span></p>
                            <p class="text-sm text-gray-500">Per Check: <span id="per-paycheck-bills-display" class="font-semibold text-red-600">$0.00</span></p>
                        </div>
                    </div>
                    <form id="transaction-form" class="space-y-4">
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-600">Description</label>
                            <input type="text" id="description" placeholder="e.g., Rent, Groceries" class="input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2" required>
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-600">Amount</label>
                            <input type="number" id="amount" placeholder="0.00" step="0.01" class="input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 font-semibold">
                            Add Expense
                        </button>
                    </form>
                </section>

                <section id="transactions" class="card">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">History</h2>
                        <button id="import-bills" class="bg-gray-200 text-gray-700 text-sm py-1 px-3 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 font-semibold">
                            Import Bills
                        </button>
                    </div>
                    <ul id="transaction-list" class="space-y-3 max-h-96 overflow-y-auto"></ul>
                </section>
            </main>

            <main id="investing-page" class="space-y-8 hidden">
                <section class="card">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">Retirement Profile</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="current-age" class="block text-sm font-medium text-gray-600">Current Age</label>
                            <input type="number" id="current-age" class="input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="retirement-age" class="block text-sm font-medium text-gray-600">Retirement Age</label>
                            <input type="number" id="retirement-age" class="input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2">
                        </div>
                    </div>
                </section>
                <section class="card text-center">
                    <div class="grid grid-cols-2 divide-x divide-gray-200">
                        <div class="px-2 sm:px-4">
                            <p class="text-gray-500 text-sm">Projected Balance</p>
                            <p id="projected-balance" class="text-3xl font-bold text-green-600 my-2">$0</p>
                        </div>
                        <div class="px-2 sm:px-4">
                            <p class="text-gray-500 text-sm">Annual Income (4%)</p>
                            <p id="annual-withdrawal" class="text-3xl font-bold text-green-600 my-2">$0</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-4 pt-4 border-t border-gray-200">Based on <span id="projection-basis">last month's</span> contributions and a <span class="font-semibold">9%</span> average annual return.</p>
                </section>
                <section class="card">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Current Snapshot</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Contributions to Date:</span>
                            <span id="total-contributions-display" class="font-medium text-gray-800">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Last Month's Contribution:</span>
                            <span id="last-month-contribution-display" class="font-medium text-gray-800">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Years to Grow:</span>
                            <span id="years-to-grow-display" class="font-medium text-gray-800">0</span>
                        </div>
                    </div>
                </section>
                <section class="card">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">Projection Simulator</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="sim-contribution" class="block text-sm font-medium text-gray-600">New Contribution Amount</label>
                            <input type="number" id="sim-contribution" class="input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2" placeholder="e.g., 250">
                        </div>
                        <div>
                            <label for="sim-frequency" class="block text-sm font-medium text-gray-600">Frequency</label>
                            <select id="sim-frequency" class="input-field mt-1 block w-full rounded-lg shadow-sm sm:text-sm p-2">
                                <option value="weekly">Weekly</option>
                                <option value="bi-weekly">Bi-weekly</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <p class="text-gray-500 text-sm">New Projected Balance</p>
                        <p id="sim-projected-balance" class="text-3xl font-bold text-blue-600 my-2">$0</p>
                    </div>
                </section>
            </main>
        </div>

        <!-- Data Management Section -->
        <footer class="card mt-8 text-center">
             <h2 class="text-xl font-semibold text-gray-800 mb-4">Data Management</h2>
             <div class="flex space-x-4">
                <button id="save-data-btn" class="flex-1 bg-blue-600 text-white py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 font-semibold">
                    Save Data
                </button>
                <button id="clear-data-btn" class="flex-1 bg-red-600 text-white py-2.5 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200 font-semibold">
                    Clear All Data
                </button>
             </div>
        </footer>

        <!-- Navigation Bar -->
        <nav id="nav-bar" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm border-t border-gray-200 shadow-t-sm">
            <div class="max-w-lg mx-auto flex justify-around">
                <button data-page="budget-page" class="nav-tab active flex-1 flex flex-col items-center p-3 text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                    <span class="text-xs">Budget</span>
                </button>
                <button data-page="investing-page" class="nav-tab flex-1 flex flex-col items-center p-3 text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    <span class="text-xs">Investing</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- App Logic -->
    <script>
        // --- App State ---
        let allTransactions = [];
        let settings = {};
        let selectedMonth = new Date().getMonth();
        let selectedYear = new Date().getFullYear();

        // --- DOM Elements ---
        const budgetPage = document.getElementById('budget-page');
        const investingPage = document.getElementById('investing-page');
        const navTabs = document.querySelectorAll('.nav-tab');
        const totalIncomeEl = document.getElementById('total-income');
        const totalSavedEl = document.getElementById('total-saved');
        const totalInvestedEl = document.getElementById('total-invested');
        const transactionForm = document.getElementById('transaction-form');
        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const transactionList = document.getElementById('transaction-list');
        const paycheckInputs = document.querySelectorAll('.paycheck-input');
        const payFrequencySelect = document.getElementById('pay-frequency');
        const weeklyPaychecksContainer = document.getElementById('weekly-paychecks');
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const importBillsBtn = document.getElementById('import-bills');
        const breakdownPaycheckSelect = document.getElementById('breakdown-paycheck-select');
        const breakdownDetailsContainer = document.getElementById('breakdown-details');
        const totalMonthlyBillsDisplay = document.getElementById('total-monthly-bills-display');
        const perPaycheckBillsDisplay = document.getElementById('per-paycheck-bills-display');
        const currentAgeInput = document.getElementById('current-age');
        const retirementAgeInput = document.getElementById('retirement-age');
        const projectedBalanceEl = document.getElementById('projected-balance');
        const annualWithdrawalEl = document.getElementById('annual-withdrawal');
        const totalContributionsDisplay = document.getElementById('total-contributions-display');
        const lastMonthContributionDisplay = document.getElementById('last-month-contribution-display');
        const yearsToGrowDisplay = document.getElementById('years-to-grow-display');
        const projectionBasisEl = document.getElementById('projection-basis');
        const simContributionInput = document.getElementById('sim-contribution');
        const simFrequencySelect = document.getElementById('sim-frequency');
        const simProjectedBalanceEl = document.getElementById('sim-projected-balance');
        const saveDataBtn = document.getElementById('save-data-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');

        // --- Data Persistence (Local Storage) ---
        function saveData() {
            localStorage.setItem('budgetAppSettings', JSON.stringify(settings));
            localStorage.setItem('budgetAppTransactions', JSON.stringify(allTransactions));
            alert('Data Saved!');
        }

        function loadData() {
            const savedSettings = localStorage.getItem('budgetAppSettings');
            const savedTransactions = localStorage.getItem('budgetAppTransactions');

            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                if (!settings.monthlyData) settings.monthlyData = {};
            } else {
                settings = { monthlyData: {} };
            }

            if (savedTransactions) {
                allTransactions = JSON.parse(savedTransactions);
            } else {
                allTransactions = [];
            }
            updateUI();
        }

        clearDataBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
                localStorage.removeItem('budgetAppSettings');
                localStorage.removeItem('budgetAppTransactions');
                window.location.reload();
            }
        });

        saveDataBtn.addEventListener('click', saveData);

        // --- Date Handling ---
        function initializeDateSelectors() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthSelect.innerHTML = months.map((month, index) => `<option value="${index}">${month}</option>`).join('');
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let i = currentYear + 10; i >= currentYear - 5; i--) {
                yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
            }

            monthSelect.value = selectedMonth;
            yearSelect.value = selectedYear;
        }

        // --- Filtering ---
        function getFilteredTransactions() {
            return allTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.timestamp);
                return transactionDate.getMonth() == selectedMonth && transactionDate.getFullYear() == selectedYear;
            });
        }

        // --- UI Rendering ---
        function updateUI() {
            const monthKey = `${selectedYear}-${selectedMonth}`;
            const monthlySettings = settings.monthlyData?.[monthKey] || {};

            payFrequencySelect.value = settings.payFrequency || 'bi-weekly';
            currentAgeInput.value = settings.currentAge || '';
            retirementAgeInput.value = settings.retirementAge || '';
            for(let i = 1; i <= 4; i++) {
                document.getElementById(`paycheck${i}`).value = monthlySettings[`paycheck${i}`] || '';
            }
            updatePayFrequencyUI();

            const filteredTransactions = getFilteredTransactions();
            renderTransactions(filteredTransactions);
            updateSummary();
            updatePaycheckBreakdown();
            updateAddExpenseHeader(filteredTransactions);
            calculateInvestmentProjection();
            runSimulation();
        }

        function renderTransactions(transactions) {
            transactionList.innerHTML = '';
            if (transactions.length === 0) {
                transactionList.innerHTML = `<li class="text-center text-gray-500 py-4">No expenses logged for this period.</li>`;
                return;
            }
            
            transactions.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-3 rounded-lg fade-in bg-red-50`;
                li.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800">${transaction.description}</p>
                        <p class="text-xs text-gray-500">${new Date(transaction.timestamp).toLocaleDateString()}</p>
                    </div>
                    <span class="font-bold text-red-600">-$${parseFloat(transaction.amount).toFixed(2)}</span>
                    <button data-id="${transaction.id}" class="delete-btn ml-4 text-gray-400 hover:text-red-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>`;
                transactionList.appendChild(li);
            });
        }

        function updateSummary() {
            const monthKey = `${selectedYear}-${selectedMonth}`;
            const monthlySettings = settings.monthlyData?.[monthKey] || {};
            
            let income = 0, totalSaved = 0, totalInvested = 0;
            const numPaychecks = payFrequencySelect.value === 'weekly' ? 4 : 2;
            for (let i = 1; i <= numPaychecks; i++) {
                income += parseFloat(monthlySettings[`paycheck${i}`]) || 0;
                totalSaved += parseFloat(monthlySettings[`saving_p${i}`]) || 0;
                totalInvested += parseFloat(monthlySettings[`investing_p${i}`]) || 0;
            }
            totalIncomeEl.textContent = `$${income.toFixed(2)}`;
            totalSavedEl.textContent = `$${totalSaved.toFixed(2)}`;
            totalInvestedEl.textContent = `$${totalInvested.toFixed(2)}`;
        }

        function updatePaycheckBreakdown() {
            const selectedPaycheckIndex = breakdownPaycheckSelect.value;
            if (!selectedPaycheckIndex) return;

            const monthKey = `${selectedYear}-${selectedMonth}`;
            const monthlySettings = settings.monthlyData?.[monthKey] || {};

            const paycheckAmount = parseFloat(monthlySettings[`paycheck${selectedPaycheckIndex}`]) || 0;
            const totalBills = getFilteredTransactions().reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const numPaychecks = payFrequencySelect.value === 'weekly' ? 4 : 2;
            const proratedBills = numPaychecks > 0 ? totalBills / numPaychecks : 0;
            
            const savingAmount = parseFloat(monthlySettings[`saving_p${selectedPaycheckIndex}`]) || 0;
            const investingAmount = parseFloat(monthlySettings[`investing_p${selectedPaycheckIndex}`]) || 0;
            const remainingAmount = paycheckAmount - proratedBills - savingAmount - investingAmount;

            const formatPercent = (amount) => paycheckAmount > 0 ? `(${(amount / paycheckAmount * 100).toFixed(1)}%)` : '(0.0%)';

            breakdownDetailsContainer.innerHTML = `
                <div class="flex justify-between items-center pb-2">
                    <span class="text-gray-600">Income:</span>
                    <div class="flex items-baseline justify-end space-x-2">
                        <span class="w-24 text-right font-semibold text-green-600">$${paycheckAmount.toFixed(2)}</span>
                        <span class="w-16 text-left text-xs text-gray-500 font-normal">${formatPercent(paycheckAmount)}</span>
                    </div>
                </div>
                <div class="flex justify-between items-center border-t border-gray-100 pt-2 pb-2">
                    <span class="text-gray-600">Bills:</span>
                    <div class="flex items-baseline justify-end space-x-2">
                        <span class="w-24 text-right font-semibold text-red-600">-$${proratedBills.toFixed(2)}</span>
                        <span class="w-16 text-left text-xs text-gray-500 font-normal">${formatPercent(proratedBills)}</span>
                    </div>
                </div>
                <div class="flex justify-between items-center border-t border-gray-100 pt-2 pb-2">
                    <label for="saving-breakdown" class="text-gray-600">Saving:</label>
                    <div class="flex items-baseline justify-end space-x-2">
                        <input type="number" id="saving-breakdown" value="${savingAmount.toFixed(2)}" class="w-24 text-right font-semibold border-b border-gray-300 text-blue-600 focus:outline-none bg-transparent" placeholder="0.00">
                        <span class="w-16 text-left text-xs text-gray-500 font-normal">${formatPercent(savingAmount)}</span>
                    </div>
                </div>
                <div class="flex justify-between items-center border-t border-gray-100 pt-2 pb-2">
                    <label for="investing-breakdown" class="text-gray-600">Investing:</label>
                    <div class="flex items-baseline justify-end space-x-2">
                        <input type="number" id="investing-breakdown" value="${investingAmount.toFixed(2)}" class="w-24 text-right font-semibold border-b border-gray-300 text-purple-600 focus:outline-none bg-transparent" placeholder="0.00">
                        <span class="w-16 text-left text-xs text-gray-500 font-normal">${formatPercent(investingAmount)}</span>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3 mt-2"></div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-600 font-semibold">Left to Spend:</span>
                    <div class="flex items-baseline justify-end space-x-2">
                        <span class="w-24 text-right font-bold text-gray-800">$${remainingAmount.toFixed(2)}</span>
                        <span class="w-16 text-left text-xs text-gray-500 font-normal">${formatPercent(remainingAmount)}</span>
                    </div>
                </div>
                <div class="mt-4 space-y-2">
                    <div class="h-2.5 w-full bg-gray-200 rounded-full flex overflow-hidden">
                        <div id="bar-bills" class="bg-red-500 transition-all duration-300"></div>
                        <div id="bar-saving" class="bg-blue-500 transition-all duration-300"></div>
                        <div id="bar-investing" class="bg-purple-600 transition-all duration-300"></div>
                        <div id="bar-remaining" class="bg-green-500 transition-all duration-300"></div>
                    </div>
                </div>
            `;
            
            const billsPercent = paycheckAmount > 0 ? (proratedBills / paycheckAmount) * 100 : 0;
            const savingPercent = paycheckAmount > 0 ? (savingAmount / paycheckAmount) * 100 : 0;
            const investingPercent = paycheckAmount > 0 ? (investingAmount / paycheckAmount) * 100 : 0;
            const remainingPercent = paycheckAmount > 0 ? (remainingAmount / paycheckAmount) * 100 : 0;

            document.getElementById('bar-bills').style.width = `${billsPercent}%`;
            document.getElementById('bar-saving').style.width = `${savingPercent}%`;
            document.getElementById('bar-investing').style.width = `${investingPercent}%`;
            document.getElementById('bar-remaining').style.width = `${Math.max(0, remainingPercent)}%`;
        }

        function updateAddExpenseHeader(filteredTransactions) {
            const totalBills = filteredTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const numPaychecks = payFrequencySelect.value === 'weekly' ? 4 : 2;
            const perPaycheckAmount = numPaychecks > 0 ? totalBills / numPaychecks : 0;

            totalMonthlyBillsDisplay.textContent = `$${totalBills.toFixed(2)}`;
            perPaycheckBillsDisplay.textContent = `$${perPaycheckAmount.toFixed(2)}`;
        }

        function calculateFutureValue(principal, annualContribution, years, annualROR) {
            let futureValue = principal;
            for (let i = 0; i < years; i++) {
                futureValue = (futureValue + annualContribution) * (1 + annualROR);
            }
            return futureValue;
        }

        function calculateInvestmentProjection() {
            const currentAge = parseInt(currentAgeInput.value) || 0;
            const retirementAge = parseInt(retirementAgeInput.value) || 0;
            const yearsToGrow = retirementAge > currentAge ? retirementAge - currentAge : 0;
            
            let totalContributions = 0;
            if (settings.monthlyData) {
                for (const monthKey in settings.monthlyData) {
                    const monthlySettings = settings.monthlyData[monthKey];
                    for (const key in monthlySettings) {
                        if (key.startsWith('investing_p')) {
                            totalContributions += parseFloat(monthlySettings[key]) || 0;
                        }
                    }
                }
            }
            
            let lastMonthDate = new Date();
            lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
            const lastMonthKey = `${lastMonthDate.getFullYear()}-${lastMonthDate.getMonth()}`;
            const lastMonthSettings = settings.monthlyData?.[lastMonthKey] || {};
            
            let lastMonthContribution = 0;
            const numPaychecks = settings.payFrequency === 'weekly' ? 4 : 2;
             for (let i = 1; i <= numPaychecks; i++) {
                lastMonthContribution += parseFloat(lastMonthSettings[`investing_p${i}`]) || 0;
            }

            let projectionBasisText = "last month's";
            let annualContribution = lastMonthContribution * 12;

            // Fallback to current month's plan if last month has no data
            if(lastMonthContribution === 0) {
                const currentMonthKey = `${selectedYear}-${selectedMonth}`;
                const currentMonthlySettings = settings.monthlyData?.[currentMonthKey] || {};
                let currentMonthContribution = 0;
                for (let i = 1; i <= numPaychecks; i++) {
                    currentMonthContribution += parseFloat(currentMonthlySettings[`investing_p${i}`]) || 0;
                }
                annualContribution = currentMonthContribution * 12;
                projectionBasisText = "current month's";
            }

            const projectedValue = calculateFutureValue(totalContributions, annualContribution, yearsToGrow, 0.09);
            const annualWithdrawal = projectedValue * 0.04;

            projectedBalanceEl.textContent = `$${Math.round(projectedValue).toLocaleString()}`;
            annualWithdrawalEl.textContent = `$${Math.round(annualWithdrawal).toLocaleString()}`;
            totalContributionsDisplay.textContent = `$${totalContributions.toFixed(2)}`;
            lastMonthContributionDisplay.textContent = `$${lastMonthContribution.toFixed(2)}`;
            yearsToGrowDisplay.textContent = yearsToGrow;
            projectionBasisEl.textContent = projectionBasisText;
        }
        
        function runSimulation() {
            const currentAge = parseInt(currentAgeInput.value) || 0;
            const retirementAge = parseInt(retirementAgeInput.value) || 0;
            const yearsToGrow = retirementAge > currentAge ? retirementAge - currentAge : 0;

            let totalContributions = 0;
            if (settings.monthlyData) {
                for (const monthKey in settings.monthlyData) {
                    const monthlySettings = settings.monthlyData[monthKey];
                    for (const key in monthlySettings) {
                        if (key.startsWith('investing_p')) {
                            totalContributions += parseFloat(monthlySettings[key]) || 0;
                        }
                    }
                }
            }
            
            const simContribution = parseFloat(simContributionInput.value) || 0;
            const simPeriodsPerYear = simFrequencySelect.value === 'weekly' ? 52 : 26;
            const simAnnualContribution = simContribution * simPeriodsPerYear;

            const simValue = calculateFutureValue(totalContributions, simAnnualContribution, yearsToGrow, 0.09);
            simProjectedBalanceEl.textContent = `$${Math.round(simValue).toLocaleString()}`;
        }

        function saveAllData() {
             try {
                // Save global settings
                settings.payFrequency = payFrequencySelect.value;
                settings.currentAge = currentAgeInput.value;
                settings.retirementAge = retirementAgeInput.value;
                
                const monthKey = `${selectedYear}-${selectedMonth}`;
                if (!settings.monthlyData) settings.monthlyData = {};
                if (!settings.monthlyData[monthKey]) settings.monthlyData[monthKey] = {};

                for(let i = 1; i <= 4; i++) {
                    settings.monthlyData[monthKey][`paycheck${i}`] = document.getElementById(`paycheck${i}`).value;
                }
                
                saveData();
             } catch (error) { console.error("Error saving settings:", error); }
        }

        // --- Event Listeners ---
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const pageId = tab.dataset.page;
                navTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                budgetPage.classList.toggle('hidden', pageId !== 'budget-page');
                investingPage.classList.toggle('hidden', pageId !== 'investing-page');
            });
        });

        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);
            if (description === '' || isNaN(amount) || amount <= 0) return;
            const transactionDate = new Date(selectedYear, selectedMonth, new Date().getDate());
            
            const newTransaction = {
                id: `id_${new Date().getTime()}`, // Simple unique ID
                description, 
                amount, 
                type: 'expense', 
                timestamp: transactionDate.getTime()
            };
            allTransactions.push(newTransaction);
            transactionForm.reset();
            saveAllData();
            updateUI();
        });
        
        transactionList.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const id = deleteButton.dataset.id;
                allTransactions = allTransactions.filter(t => t.id !== id);
                saveAllData();
                updateUI();
            }
        });
        
        importBillsBtn.addEventListener('click', () => {
            let prevMonth = selectedMonth - 1, prevYear = selectedYear;
            if (prevMonth < 0) { prevMonth = 11; prevYear--; }

            const prevMonthTransactions = allTransactions.filter(t => {
                const d = new Date(t.timestamp);
                return d.getMonth() === prevMonth && d.getFullYear() === prevYear;
            });

            if (prevMonthTransactions.length === 0) { alert("No bills found in the previous month to import."); return; }
            const currentMonthDescriptions = new Set(getFilteredTransactions().map(t => t.description));
            let importCount = 0;

            prevMonthTransactions.forEach(t => {
                if (!currentMonthDescriptions.has(t.description)) {
                    allTransactions.push({
                        id: `id_${new Date().getTime()}_${importCount}`,
                        description: t.description, 
                        amount: t.amount, 
                        type: 'expense', 
                        timestamp: new Date(selectedYear, selectedMonth, 1).getTime()
                    });
                    importCount++;
                }
            });

            if (importCount > 0) {
                saveAllData();
                updateUI();
                alert(`Successfully imported ${importCount} bill(s).`); 
            } else {
                alert("All bills from the previous month already exist.");
            }
        });
        
        function handlePeriodChange() {
            selectedMonth = parseInt(monthSelect.value);
            selectedYear = parseInt(yearSelect.value);
            updateUI();
        }
        
        function updatePayFrequencyUI() {
            const isWeekly = payFrequencySelect.value === 'weekly';
            weeklyPaychecksContainer.classList.toggle('hidden', !isWeekly);
            
            const numPaychecks = isWeekly ? 4 : 2;
            const currentSelection = breakdownPaycheckSelect.value;
            breakdownPaycheckSelect.innerHTML = '';
            for(let i=1; i<=numPaychecks; i++) {
                breakdownPaycheckSelect.innerHTML += `<option value="${i}">Paycheck ${i}</option>`;
            }
            if (currentSelection > 0 && currentSelection <= numPaychecks) {
                breakdownPaycheckSelect.value = currentSelection;
            }
        }

        function handlePayFrequencyChange() {
            settings.payFrequency = payFrequencySelect.value;
            saveAllData();
            updatePayFrequencyUI();
            updateUI();
        }

        function handleBreakdownInputChange(e) {
            const selectedPaycheckIndex = breakdownPaycheckSelect.value;
            const type = e.target.id.split('-')[0];
            const key = `${type}_p${selectedPaycheckIndex}`;
            
            const monthKey = `${selectedYear}-${selectedMonth}`;
            if (!settings.monthlyData) settings.monthlyData = {};
            if (!settings.monthlyData[monthKey]) settings.monthlyData[monthKey] = {};
            
            settings.monthlyData[monthKey][key] = e.target.value;
            saveAllData();
            updateUI();
        }

        function handlePaycheckInputChange(e) {
            const monthKey = `${selectedYear}-${selectedMonth}`;
            if (!settings.monthlyData) settings.monthlyData = {};
            if (!settings.monthlyData[monthKey]) settings.monthlyData[monthKey] = {};
            
            settings.monthlyData[monthKey][e.target.id] = e.target.value;
            saveAllData();
            updateUI();
        }
        
        breakdownDetailsContainer.addEventListener('focusin', (e) => {
            if (e.target.matches('#saving-breakdown') || e.target.matches('#investing-breakdown')) {
                e.target.select();
            }
        });
        breakdownDetailsContainer.addEventListener('change', (e) => {
            if (e.target.matches('#saving-breakdown') || e.target.matches('#investing-breakdown')) {
                handleBreakdownInputChange(e);
            }
        });

        [...paycheckInputs, amountInput, currentAgeInput, retirementAgeInput, simContributionInput].forEach(input => {
            input.addEventListener('focus', (e) => e.target.select());
        });

        monthSelect.addEventListener('change', handlePeriodChange);
        yearSelect.addEventListener('change', handlePeriodChange);
        payFrequencySelect.addEventListener('change', handlePayFrequencyChange);
        paycheckInputs.forEach(input => input.addEventListener('change', handlePaycheckInputChange));
        breakdownPaycheckSelect.addEventListener('change', updatePaycheckBreakdown);
        currentAgeInput.addEventListener('change', saveAllData);
        retirementAgeInput.addEventListener('change', saveAllData);
        simContributionInput.addEventListener('input', runSimulation);
        simFrequencySelect.addEventListener('change', runSimulation);

        // --- Initial Load ---
        window.onload = () => {
            initializeDateSelectors();
            loadData();
        };

    </script>
</body>
</html>
